services:
  mariadb-node1:
    image: mariadb:lts
    container_name: mariadb-galera-node1
    hostname: mariadb-node1
    restart: unless-stopped
    network_mode: host

    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      TZ: "${TZ}"

    volumes:
      - mariadb_data:/var/lib/mysql
      - ./conf/galera-prd1.cnf:/etc/mysql/conf.d/galera.cnf:ro
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
      - mariadb_logs:/var/log/mysql

    # Smart bootstrap: Uses --wsrep-new-cluster ONLY if BOOTSTRAP_NODE1=yes
    # For initial deployment: Set BOOTSTRAP_NODE1=yes in .env
    # After cluster is running: Remove BOOTSTRAP_NODE1 or set to empty in Portainer environment variables
    # Safe for reboots when BOOTSTRAP_NODE1 is unset or empty
    command:
      - bash
      - -c
      - |
        if [ "$BOOTSTRAP_NODE1" = "yes" ]; then
          exec docker-entrypoint.sh mariadbd \
            --wsrep-new-cluster \
            --wsrep-on=ON \
            --wsrep-provider=/usr/lib/galera/libgalera_smm.so \
            --wsrep-cluster-name="$CLUSTER_NAME" \
            --wsrep-cluster-address=gcomm://$HOST1_IP:4567,$HOST2_IP:4567 \
            --wsrep-node-name=prd1 \
            --wsrep-node-address=$HOST1_IP \
            --wsrep-sst-method=rsync \
            --wsrep-sst-auth="$SST_USER:$SST_PASSWORD" \
            --binlog-format=ROW \
            --default-storage-engine=InnoDB \
            --innodb-autoinc-lock-mode=2 \
            --bind-address=0.0.0.0
        else
          exec docker-entrypoint.sh mariadbd \
            --wsrep-on=ON \
            --wsrep-provider=/usr/lib/galera/libgalera_smm.so \
            --wsrep-cluster-name="$CLUSTER_NAME" \
            --wsrep-cluster-address=gcomm://$HOST1_IP:4567,$HOST2_IP:4567 \
            --wsrep-node-name=prd1 \
            --wsrep-node-address=$HOST1_IP \
            --wsrep-sst-method=rsync \
            --wsrep-sst-auth="$SST_USER:$SST_PASSWORD" \
            --binlog-format=ROW \
            --default-storage-engine=InnoDB \
            --innodb-autoinc-lock-mode=2 \
            --bind-address=0.0.0.0
        fi

    healthcheck:
      disable: true

volumes:
  mariadb_data:
    driver: local
  mariadb_logs:
    driver: local

networks:
  galera_network:
    driver: host
    ipam:
      config:
        - subnet: "${GALERA_SUBNET}"
          gateway: "${GALERA_GATEWAY}"

