version: '3.8'

services:
  mariadb-node1:
    image: mariadb:lts
    container_name: mariadb-galera-node1
    hostname: mariadb-node1
    restart: unless-stopped
    network_mode: host

    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      TZ: "${TZ}"

    volumes:
      - mariadb_data:/var/lib/mysql
      - /data/docker_configs/mariadb_galera/conf/galera-prd1.cnf:/etc/mysql/conf.d/galera.cnf:ro
      - /data/docker_configs/mariadb_galera/init-scripts:/docker-entrypoint-initdb.d:ro
      - mariadb_logs:/var/log/mysql
        
    command: >
      --wsrep-new-cluster
      --wsrep-on=ON
      --wsrep-provider=/usr/lib/galera/libgalera_smm.so
      --wsrep-cluster-name="${CLUSTER_NAME}"
      --wsrep-cluster-address=gcomm://${HOST1_IP}:4567,${HOST2_IP}:4567
      --wsrep-node-name=prd1
      --wsrep-node-address=${HOST1_IP}
      --wsrep-sst-method=rsync
      --wsrep-sst-auth="${SST_USER}:${SST_PASSWORD}"
      --binlog-format=ROW
      --default-storage-engine=InnoDB
      --innodb-autoinc-lock-mode=2
      --bind-address=0.0.0.0
      
    healthcheck:
      disable: true

volumes:
  mariadb_data:
    driver: local
  mariadb_logs:
    driver: local

