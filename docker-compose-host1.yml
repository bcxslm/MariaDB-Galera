services:
  mariadb-node1:
    image: mariadb:lts
    container_name: mariadb-galera-node1
    hostname: mariadb-node1
    restart: unless-stopped
    network_mode: host

    environment:
      TZ: "${TZ}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"

    volumes:
      - ./data:/var/lib/mysql
      - ./conf/galera-prd1.cnf:/etc/mysql/conf.d/galera.cnf:ro
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
      - ./logs:/var/log/mysql

    command:
      - bash
      - -c
      - |
        if [ "$BOOTSTRAP_NODE1" = "yes" ]; then
          echo "### Starting NEW Galera cluster (bootstrap node) ###"
          exec docker-entrypoint.sh mariadbd \
            --wsrep-new-cluster \
            --wsrep_cluster_name="$CLUSTER_NAME" \
            --wsrep_cluster_address="gcomm://$HOST1_IP:4567,$HOST2_IP:4567" \
            --wsrep_node_name="prd1" \
            --wsrep_node_address="$HOST1_IP" \
            --wsrep_sst_auth="$SST_USER:$SST_PASSWORD"
        else
          echo "### Joining existing Galera cluster ###"
          exec docker-entrypoint.sh mariadbd \
            --wsrep_cluster_name="$CLUSTER_NAME" \
            --wsrep_cluster_address="gcomm://$HOST1_IP:4567,$HOST2_IP:4567" \
            --wsrep_node_name="prd1" \
            --wsrep_node_address="$HOST1_IP" \
            --wsrep_sst_auth="$SST_USER:$SST_PASSWORD"
        fi
